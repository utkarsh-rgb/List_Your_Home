<% layout("layouts/boilerplate.ejs") %>

<style>
    body {
        background-color: #fff9f9;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        color: #3b3b3b;
    }

    .container {
        max-width: 900px;
    }

    h2 {
        color: #000000;
        font-weight: 700;
        margin-bottom: 1.5rem;
    }

    .card {
        border-radius: 20px;
        box-shadow: 0 6px 24px rgba(254, 66, 77, 0.12);
        border: none;
        margin-bottom: 2rem;
    }

    .card-img-top {
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        max-height: 400px;
        object-fit: cover;
        width: 100%;
        height: 100%;
    }

    .card-body {
        padding: 1.5rem 2rem;
    }

    .text-muted {
        color: #777777;
    }

    p,
    h5 {
        margin: 0.2rem 0;
    }

    .text-danger {
        color: #fe424d !important;
    }

    .fa-location-dot,
    .fa-user,
    .fa-star {
        color: #fe424d;
        margin-right: 4px;
    }

    .fa-regular.fa-star {
        color: #ccc;
    }

    /* Buttons */
    .btn-dark, .btn-outline-danger, .btn-outline-dark {
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .btn-dark {
        background-color: #222222;
        color: white;
        box-shadow: 0 4px 15px rgba(34, 34, 34, 0.25);
    }

    .btn-dark:hover {
        background-color: #000000;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        transform: translateY(-2px);
    }
    
    .btn-outline-danger {
        color: #fe424d;
        border-color: #fe424d;
    }

    .btn-outline-danger:hover {
        background-color: #fe424d;
        color: white;
        border-color: #d1323a;
    }

    .btn-outline-dark {
        color: #222222;
        border-color: #222222;
    }

    .btn-outline-dark:hover {
        background-color: #222222;
        color: white;
        border-color: #000000;
    }

    /* Reviews */
    .star-display i {
        font-size: 1rem;
    }

    /* Layout and spacing */
    .d-flex {
        display: flex !important;
    }

    .flex-fill {
        flex: 1 1 auto !important;
    }

    .flex-column {
        flex-direction: column !important;
    }

    .flex-md-row {
        flex-direction: row !important;
    }

    .gap-2 > * + *,
    .gap-md-3 > * + * {
        margin-left: 0.5rem;
    }

    .gap-md-3 {
        gap: 1rem !important;
    }

    .mt-3 {
        margin-top: 1rem !important;
    }

    .mb-4 {
        margin-bottom: 1.5rem !important;
    }

    .mb-2 {
        margin-bottom: 0.5rem !important;
    }

    .mb-1 {
        margin-bottom: 0.25rem !important;
    }

    /* Star rating styles */
    .star-rating input[type="radio"] {
        display: none;
    }

    .star-rating label {
        font-size: 2rem;
        color: #ddd;
        cursor: pointer;
        transition: color 0.3s;
        user-select: none;
    }

    .star-rating label:hover,
    .star-rating label:hover ~ label {
        color: #fe424d;
    }

    .star-rating input[type="radio"]:checked ~ label {
        color: #fe424d;
    }

    .star-rating {
        display: flex;
        flex-direction: row-reverse;
        justify-content: flex-start;
    }

    .star-rating.is-invalid label {
        color: #d1323a !important;
    }

    /* Responsive adjustments */
    @media (max-width: 767.98px) {
        .d-md-flex {
            display: block !important;
        }
        .flex-md-row {
            flex-direction: column !important;
        }
        .gap-md-3 {
            gap: 0.5rem !important;
        }
        .btn.flex-fill {
            width: 100% !important;
        }
    }
</style>

<div class="container mt-4">

  <!-- Title -->
  <div class="row">
    <div class="col-12 col-md-8 offset-md-2">
      <h2 class="fw-bold mb-3 text-center text-md-start"><%= listing.title %></h2>
    </div>
  </div>

  <!-- Image and Listing Details Side-by-side -->
  <div class="row mb-4 align-items-center">
    <!-- Image half -->
    <div class="col-12 col-md-6 mb-3 mb-md-0">
      <div >
        <img 
          src="<%= listing.image.url %>" 
          class="card-img-top img-fluid" 
          alt="listing_img" 
          style="object-fit: cover; height: 100%; width: 100%;"
        />
      </div>
    </div>

    <!-- Data half -->
    <div class="col-12 col-md-6">
      <div class="card shadow-sm rounded-4 p-4 h-100">
        <h5 class="text-muted mb-2">Hosted by <i><%= listing.owner.username %></i></h5>
        <p class="mb-3"><%= listing.description %></p>
        <p class="fw-bold fs-4 text-danger mb-3">&#8377; <%= listing.price.toLocaleString("en-IN") %></p>
<p class="text-muted">
  <i class="fa-solid fa-location-dot me-1"></i>
  <a href="<%= getLocationMapLink(listing.location, listing.country) %>" target="_blank">
    <%= listing.location %>, <%= listing.country %>
  </a>
</p>


        <% if(currentUser && currentUser._id.equals(listing.owner._id)) { %>
          <div class="mt-4 d-flex flex-column flex-md-row gap-2 gap-md-3">
            <a href="/listings/<%= listing._id %>/edit" class="btn btn-dark flex-fill">Edit</a>
            <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE" class="flex-fill">
              <button class="btn btn-outline-danger w-100" onclick="return confirm('Are you sure you want to delete this listing?');">Delete</button>
            </form>
          </div>
        <% } %>
      </div>
    </div>
  </div>

  <!-- Reviews Section -->
  <div class="row">
    <div class="col-12 col-md-8 offset-md-2">
      <hr />
      <% if(currentUser) { %>
      <h4 class="mb-3">Leave a Review</h4>
      <form action="/listings/<%= listing._id %>/reviews" method="POST" novalidate class="needs-validation" id="reviewForm">
        <div class="mb-3">
          <label for="rating" class="form-label">Rating:</label>
          <div class="star-rating" role="radiogroup" aria-labelledby="ratingLabel" id="starRating">
            <% for(let i = 5; i >= 1; i--) { %>
              <input type="radio" name="review[rating]" id="star-<%= i %>" value="<%= i %>" required>
              <label for="star-<%= i %>" title="<%= i %> stars">&#9733;</label>
            <% } %>
          </div>
          <div class="invalid-feedback">Please select a rating.</div>
        </div>
        <div class="mb-3">
          <label for="comment" class="form-label">Comment:</label>
          <textarea id="comment" name="review[comment]" rows="4" class="form-control" required></textarea>
          <div class="invalid-feedback">Please enter your comment.</div>
        </div>
        <button type="submit" class="btn btn-outline-dark w-100 w-md-auto">Submit</button>
      </form>
      <hr />
      <% } %>

      <!-- All Reviews -->
      <h5 class="mb-3"><b>All Reviews</b></h5>
      <div class="row">
        <% for (let review of listing.reviews) { %>
        <div class="col-12 col-sm-6 mb-4">
          <div class="card border-0 shadow-sm rounded-4 p-3 h-100">
            <h6><i class="fa-solid fa-user me-2 text-danger"></i><%= review.author.username %></h6>
            <p class="mb-1"><%= review.comment %></p>
            <div class="star-display text-warning mb-2" style="font-size: 1.1rem;">
              <% for (let i = 1; i <= 5; i++) { %>
                <% if (i <= review.rating) { %>
                  <i class="fa-solid fa-star"></i>
                <% } else { %>
                  <i class="fa-regular fa-star"></i>
                <% } %>
              <% } %>
            </div>
            <% if(currentUser && currentUser._id.equals(review.author._id)) { %>
            <form method="POST" action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE">
              <button class="btn btn-sm btn-outline-danger w-100" onclick="return confirm('Delete this review?');">Delete</button>
            </form>
            <% } %>
          </div>
        </div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<script>
    (function () {
        'use strict';
        const form = document.getElementById('reviewForm');

        if (form) {
            form.addEventListener('submit', function (event) {
                // Check rating selection
                const ratingSelected = Array.from(form.elements['review[rating]'])
                    .some(radio => radio.checked);
                
                if (!ratingSelected) {
                    event.preventDefault();
                    event.stopPropagation();
                    form.querySelector('.star-rating').classList.add('is-invalid');
                } else {
                    form.querySelector('.star-rating').classList.remove('is-invalid');
                }

                if (!form.checkValidity() || !ratingSelected) {
                    event.preventDefault();
                    event.stopPropagation();
                }

                form.classList.add('was-validated');
            });

            // Clear star rating invalid feedback on change
            const starRadios = form.elements['review[rating]'];
            Array.from(starRadios).forEach(radio => {
                radio.addEventListener('change', () => {
                    form.querySelector('.star-rating').classList.remove('is-invalid');
                });
            });

            // Normal validation for comment input
            const comment = form.querySelector('#comment');
            comment.addEventListener('input', () => {
                if (comment.checkValidity()) {
                    comment.classList.remove('is-invalid');
                    comment.classList.add('is-valid');
                } else {
                    comment.classList.remove('is-valid');
                    comment.classList.add('is-invalid');
                }
            });
        }

        // General form validation for other forms
        const forms = document.querySelectorAll('.needs-validation');
        Array.from(forms).forEach(function (f) {
            if (f !== form) {
                f.addEventListener('submit', function (event) {
                    if (!f.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    f.classList.add('was-validated');
                });
            }
        });
    })();
</script>
